<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Known Devices</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .devices-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .device-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .device-ip {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        
        .device-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-new {
            background: #ffeb3b;
            color: #333;
        }
        
        .status-whitelisted {
            background: #4caf50;
            color: white;
        }
        
        .status-blacklisted {
            background: #dc3545;
            color: white;
        }
        
        .status-known {
            background: #2196f3;
            color: white;
        }
        
        .device-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-size: 14px;
            color: #333;
        }
        
        .device-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .btn-whitelist {
            background: #4caf50;
            color: white;
        }
        
        .btn-remove-whitelist {
            background: #f44336;
            color: white;
        }
        
        .btn-forget {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .stats-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Known Devices</h1>
            <nav>
                <a href="index.html">Dashboard</a>
                <a href="users.html">Users</a>
                <a href="access-logs.html">Access Logs</a>
                <a href="known-devices.html" class="active">Known Devices</a>
                <a href="blacklist.html">Blacklist</a>
                <a href="locations.html">Locations</a>
                <button onclick="logout()">Logout</button>
            </nav>
        </header>

        <div class="devices-container">
            <div class="stats-summary" id="statsSummary">
                <!-- Stats will be populated here -->
            </div>

            <div id="devicesList">
                <!-- Devices will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!localStorage.getItem('jwt')) {
                window.location.href = 'login.html';
                return;
            }
            loadDevices();
        });

        function logout() {
            localStorage.removeItem('jwt');
            window.location.href = 'login.html';
        }

        async function loadDevices() {
            try {
                const response = await fetch('/api/known-devices', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load devices');
                }

                const devices = await response.json();
                displayDevices(devices);
                displayStats(devices);
            } catch (error) {
                console.error('Error loading devices:', error);
                alert('Failed to load known devices');
            }
        }

        function displayStats(devices) {
            const totalDevices = devices.length;
            const whitelistedDevices = devices.filter(d => d.is_whitelisted).length;
            const blacklistedDevices = devices.filter(d => d.is_blacklisted).length;
            const newDevices = devices.filter(d => d.request_count <= 1).length;
            const activeDevices = devices.filter(d => {
                const lastSeen = new Date(d.last_seen);
                const now = new Date();
                const daysDiff = (now - lastSeen) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7; // Active in last 7 days
            }).length;

            const statsContainer = document.getElementById('statsSummary');
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalDevices}</div>
                    <div class="stat-label">Total Devices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${whitelistedDevices}</div>
                    <div class="stat-label">Whitelisted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${blacklistedDevices}</div>
                    <div class="stat-label">Blacklisted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${newDevices}</div>
                    <div class="stat-label">New Devices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${activeDevices}</div>
                    <div class="stat-label">Active (7 days)</div>
                </div>
            `;
        }

        function displayDevices(devices) {
            const container = document.getElementById('devicesList');
            
            if (devices.length === 0) {
                container.innerHTML = '<p>No known devices found.</p>';
                return;
            }

            container.innerHTML = devices.map(device => {
                const isWhitelisted = device.is_whitelisted === 1;
                const isBlacklisted = device.is_blacklisted === 1;
                const isNew = device.request_count <= 1;
                
                let statusClass = 'status-known';
                let statusText = 'Known';
                
                if (isBlacklisted) {
                    statusClass = 'status-blacklisted';
                    statusText = 'Blacklisted';
                } else if (isWhitelisted) {
                    statusClass = 'status-whitelisted';
                    statusText = 'Whitelisted';
                } else if (isNew) {
                    statusClass = 'status-new';
                    statusText = 'New';
                }

                const firstSeen = new Date(device.first_seen).toLocaleString();
                const lastSeen = new Date(device.last_seen).toLocaleString();
                const daysSinceFirst = Math.floor((new Date() - new Date(device.first_seen)) / (1000 * 60 * 60 * 24));

                return `
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-ip">${device.ip_address}</div>
                            <span class="device-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="device-details">
                            <div class="detail-item">
                                <div class="detail-label">First Seen</div>
                                <div class="detail-value">${firstSeen}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Last Seen</div>
                                <div class="detail-value">${lastSeen}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Request Count</div>
                                <div class="detail-value">${device.request_count}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Days Active</div>
                                <div class="detail-value">${daysSinceFirst}</div>
                            </div>
                            ${isBlacklisted ? `
                            <div class="detail-item">
                                <div class="detail-label">Blacklist Reason</div>
                                <div class="detail-value">${device.blacklist_reason || 'No reason provided'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Blacklisted At</div>
                                <div class="detail-value">${device.blacklisted_at ? new Date(device.blacklisted_at).toLocaleString() : 'Unknown'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Blacklisted By</div>
                                <div class="detail-value">${device.blacklisted_by || 'Unknown'}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">User Agent</div>
                            <div class="detail-value">${device.user_agent || 'Unknown'}</div>
                        </div>
                        <div class="device-actions">
                            ${isBlacklisted ? 
                                `<button class="btn" style="background: #28a745; color: white;" onclick="removeFromBlacklist('${device.ip_address}')">Remove from Blacklist</button>` :
                                `${isWhitelisted ? 
                                    `<button class="btn btn-remove-whitelist" onclick="removeWhitelist('${device.ip_address}')">Remove from Whitelist</button>` :
                                    `<button class="btn btn-whitelist" onclick="addToWhitelist('${device.ip_address}')">Add to Whitelist</button>`
                                }
                                <button class="btn" style="background: #dc3545; color: white;" onclick="blacklistDevice('${device.ip_address}')">Blacklist</button>`
                            }
                            <button class="btn btn-forget" onclick="forgetDevice('${device.ip_address}')">Forget</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addToWhitelist(ip) {
            try {
                const response = await fetch(`/api/known-devices/${encodeURIComponent(ip)}/whitelist`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to whitelist device');
                }

                alert(`Device ${ip} has been whitelisted`);
                loadDevices(); // Reload the list
            } catch (error) {
                console.error('Error whitelisting device:', error);
                alert('Failed to whitelist device');
            }
        }

        async function removeWhitelist(ip) {
            if (!confirm(`Are you sure you want to remove ${ip} from the whitelist?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/known-devices/${encodeURIComponent(ip)}/whitelist`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to remove device from whitelist');
                }

                alert(`Device ${ip} has been removed from whitelist`);
                loadDevices(); // Reload the list
            } catch (error) {
                console.error('Error removing device from whitelist:', error);
                alert('Failed to remove device from whitelist');
            }
        }

        async function blacklistDevice(ip) {
            const reason = prompt(`Enter reason for blacklisting ${ip}:`);
            if (reason === null) return; // User cancelled

            try {
                const response = await fetch('/api/blacklist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwt')}`
                    },
                    body: JSON.stringify({
                        ip_address: ip,
                        reason: reason || 'No reason provided'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to blacklist device');
                }

                alert(`Device ${ip} has been blacklisted`);
                loadDevices(); // Reload the list
            } catch (error) {
                console.error('Error blacklisting device:', error);
                alert('Failed to blacklist device');
            }
        }

        async function removeFromBlacklist(ip) {
            if (!confirm(`Are you sure you want to remove ${ip} from the blacklist?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/blacklist/${encodeURIComponent(ip)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to remove device from blacklist');
                }

                alert(`Device ${ip} has been removed from blacklist`);
                loadDevices(); // Reload the list
            } catch (error) {
                console.error('Error removing device from blacklist:', error);
                alert('Failed to remove device from blacklist');
            }
        }

        async function forgetDevice(ip) {
            if (!confirm(`Are you sure you want to forget ${ip}? This will remove it from known devices but preserve all access logs.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/known-devices/${encodeURIComponent(ip)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to forget device');
                }

                alert(`Device ${ip} has been forgotten from known devices`);
                loadDevices(); // Reload the list
            } catch (error) {
                console.error('Error forgetting device:', error);
                alert('Failed to forget device');
            }
        }
    </script>
</body>
</html> 